/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var _=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var re=Object.prototype.hasOwnProperty;var oe=(d,n)=>{for(var e in n)_(d,e,{get:n[e],enumerable:!0})},ae=(d,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of ie(n))!re.call(d,s)&&s!==e&&_(d,s,{get:()=>n[s],enumerable:!(t=se(n,s))||t.enumerable});return d};var ce=d=>ae(_({},"__esModule",{value:!0}),d);var ge={};oe(ge,{default:()=>K});module.exports=ce(ge);var y=require("obsidian");var x={claude:{id:"claude",name:"Claude",displayName:"Anthropic Claude",defaultModel:"claude-sonnet-4-5-20250929",endpoint:"https://api.anthropic.com/v1",apiKeyPrefix:"sk-ant-"},openai:{id:"openai",name:"OpenAI",displayName:"OpenAI GPT",defaultModel:"gpt-5.2",endpoint:"https://api.openai.com/v1",apiKeyPrefix:"sk-"},gemini:{id:"gemini",name:"Gemini",displayName:"Google Gemini",defaultModel:"gemini-3-flash-preview",endpoint:"https://generativelanguage.googleapis.com/v1beta",apiKeyPrefix:"AIza"},grok:{id:"grok",name:"Grok",displayName:"xAI Grok",defaultModel:"grok-4-1-fast",endpoint:"https://api.x.ai/v1"}};var le={"claude-sonnet-4-5-20250929":{id:"claude-sonnet-4-5-20250929",displayName:"Claude Sonnet 4.5",provider:"claude",maxTokens:16384,inputCostPer1M:3,outputCostPer1M:15},"claude-opus-4-5-20251101":{id:"claude-opus-4-5-20251101",displayName:"Claude Opus 4.5",provider:"claude",maxTokens:32768,inputCostPer1M:15,outputCostPer1M:75},"claude-3-5-haiku-20241022":{id:"claude-3-5-haiku-20241022",displayName:"Claude 3.5 Haiku",provider:"claude",maxTokens:8192,inputCostPer1M:.8,outputCostPer1M:4},"gpt-5.2":{id:"gpt-5.2",displayName:"GPT-5.2",provider:"openai",maxTokens:32768,inputCostPer1M:1.75,outputCostPer1M:14},"gpt-4o-mini":{id:"gpt-4o-mini",displayName:"GPT-4o Mini",provider:"openai",maxTokens:16384,inputCostPer1M:.15,outputCostPer1M:.6},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",displayName:"Gemini 3 Flash",provider:"gemini",maxTokens:65536,inputCostPer1M:.5,outputCostPer1M:3},"gemini-3-pro-preview":{id:"gemini-3-pro-preview",displayName:"Gemini 3 Pro",provider:"gemini",maxTokens:65536,inputCostPer1M:2.5,outputCostPer1M:10},"gemini-2.0-flash":{id:"gemini-2.0-flash",displayName:"Gemini 2.0 Flash",provider:"gemini",maxTokens:8192,inputCostPer1M:.075,outputCostPer1M:.3},"grok-4-1-fast":{id:"grok-4-1-fast",displayName:"Grok 4.1 Fast",provider:"grok",maxTokens:16384,inputCostPer1M:3,outputCostPer1M:15},"grok-4-1-fast-non-reasoning":{id:"grok-4-1-fast-non-reasoning",displayName:"Grok 4.1 Fast (Non-Reasoning)",provider:"grok",maxTokens:16384,inputCostPer1M:.6,outputCostPer1M:4}};function q(d){return Object.values(le).filter(n=>n.provider===d)}function H(d){return d.startsWith("gpt-5")||d.startsWith("o1")||d.startsWith("o3")}function W(d){return{...d,analyzedAt:d.analyzedAt.toISOString()}}function J(d){return{...d,analyzedAt:new Date(d.analyzedAt)}}var M={ai:{provider:"openai",apiKeys:{},models:{claude:x.claude.defaultModel,openai:x.openai.defaultModel,gemini:x.gemini.defaultModel,grok:x.grok.defaultModel},enabled:!0},clusterCount:10,minMentionsForUndefined:2,sparseDensityThreshold:.3,excludeFolders:["06_Meta","09_Embedded","templates",".obsidian"],autoAnalyze:!1,analyzeIntervalDays:7,lastAnalyzedAt:null,maxGapsInReport:50,useKMeansPlusPlus:!0,lastReport:null};var b=require("obsidian");var P=class extends b.PluginSettingTab{constructor(e,t){super(e,t);this.modelDropdown=null;this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h1",{text:"Knowledge Gap Detector"}),e.createEl("p",{text:"Detect knowledge gaps in your vault using embedding analysis and link graph.",cls:"setting-item-description"}),this.renderAISection(e),this.renderAnalysisSection(e),this.renderExclusionSection(e),this.renderAutoAnalysisSection(e),this.renderAdvancedSection(e)}renderAISection(e){e.createEl("h2",{text:"AI Settings"});let t=this.plugin.settings.ai.provider,s=x[t];new b.Setting(e).setName("Enable AI Analysis").setDesc("Use AI to infer gap topics and generate exploration suggestions").addToggle(r=>r.setValue(this.plugin.settings.ai.enabled).onChange(async o=>{this.plugin.settings.ai.enabled=o,await this.plugin.saveSettings()})),new b.Setting(e).setName("AI Provider").setDesc("Select the AI service to use").addDropdown(r=>{Object.entries(x).forEach(([o,a])=>{r.addOption(o,a.displayName)}),r.setValue(t),r.onChange(async o=>{this.plugin.settings.ai.provider=o,await this.plugin.saveSettings(),this.display()})}),new b.Setting(e).setName(`${s.displayName} API Key`).setDesc(this.getApiKeyDescription(t)).addText(r=>{var o;r.setPlaceholder("Enter API key").setValue((o=this.plugin.settings.ai.apiKeys[t])!=null?o:"").onChange(async a=>{this.plugin.settings.ai.apiKeys[t]=a,await this.plugin.saveSettings()}),r.inputEl.type="password",r.inputEl.style.width="300px"}).addButton(r=>{r.setButtonText("Test").onClick(async()=>{let o=this.plugin.settings.ai.apiKeys[t];if(!o){new b.Notice("Please enter the API key first.");return}r.setDisabled(!0),r.setButtonText("Testing...");try{await this.plugin.testApiKey(t,o)?new b.Notice(`\u2705 ${s.displayName} API key is valid!`):new b.Notice(`\u274C ${s.displayName} API key is invalid.`)}catch(a){let c=a instanceof Error?a.message:"Unknown error";new b.Notice(`\u274C Test failed: ${c}`)}finally{r.setDisabled(!1),r.setButtonText("Test")}})}).addExtraButton(r=>r.setIcon("external-link").setTooltip("Open API key page").onClick(()=>{window.open(this.getApiKeyUrl(t),"_blank")})),new b.Setting(e).setName("Model").setDesc("Select the model to use").addDropdown(r=>{var o;this.modelDropdown=r,this.populateModelDropdown(r,t),r.setValue((o=this.plugin.settings.ai.models[t])!=null?o:s.defaultModel),r.onChange(async a=>{this.plugin.settings.ai.models[t]=a,await this.plugin.saveSettings()})});let i=e.createDiv({cls:"setting-item-description"});i.style.marginTop="15px",i.style.padding="10px",i.style.backgroundColor="var(--background-secondary)",i.style.borderRadius="5px",i.innerHTML=`
      <p style="margin: 0 0 5px 0;"><strong>\u{1F4E6} Vault Embeddings Integration</strong></p>
      <p style="margin: 0; font-size: 0.9em;">Sparse Region analysis uses embedding data from the <strong>Vault Embeddings</strong> plugin.<br>
      Please run "Embed All Notes" in Vault Embeddings first.</p>
    `}populateModelDropdown(e,t){q(t).forEach(i=>{e.addOption(i.id,i.displayName)})}getApiKeyDescription(e){switch(e){case"claude":return"Obtain from Anthropic Console.";case"openai":return"Obtain from OpenAI Platform.";case"gemini":return"Obtain from Google AI Studio.";case"grok":return"Obtain from xAI Console.";default:return"Enter the API key."}}getApiKeyUrl(e){switch(e){case"claude":return"https://console.anthropic.com/settings/keys";case"openai":return"https://platform.openai.com/api-keys";case"gemini":return"https://aistudio.google.com/app/apikey";case"grok":return"https://console.x.ai/";default:return""}}renderAnalysisSection(e){e.createEl("h2",{text:"Analysis Settings"}),new b.Setting(e).setName("Cluster Count").setDesc("Number of clusters for K-means analysis (default: 10). Higher values enable finer gap detection").addSlider(t=>t.setLimits(3,30,1).setValue(this.plugin.settings.clusterCount).setDynamicTooltip().onChange(async s=>{this.plugin.settings.clusterCount=s,await this.plugin.saveSettings()})),new b.Setting(e).setName("Minimum Mentions for Undefined Concepts").setDesc("Minimum mentions required before a [[concept]] is flagged").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.minMentionsForUndefined).setDynamicTooltip().onChange(async s=>{this.plugin.settings.minMentionsForUndefined=s,await this.plugin.saveSettings()})),new b.Setting(e).setName("Sparse Density Threshold").setDesc("Regions with density below this threshold are flagged as sparse (0-1, lower = sparser)").addSlider(t=>t.setLimits(.1,.9,.1).setValue(this.plugin.settings.sparseDensityThreshold).setDynamicTooltip().onChange(async s=>{this.plugin.settings.sparseDensityThreshold=s,await this.plugin.saveSettings()})),new b.Setting(e).setName("Maximum Gaps in Report").setDesc("Maximum number of gaps to display in the analysis report").addSlider(t=>t.setLimits(10,100,10).setValue(this.plugin.settings.maxGapsInReport).setDynamicTooltip().onChange(async s=>{this.plugin.settings.maxGapsInReport=s,await this.plugin.saveSettings()}))}renderExclusionSection(e){e.createEl("h2",{text:"Exclusion Settings"}),new b.Setting(e).setName("Excluded Folders").setDesc("Folders to exclude from analysis (comma-separated)").addTextArea(t=>t.setPlaceholder("templates, .obsidian, archive").setValue(this.plugin.settings.excludeFolders.join(", ")).onChange(async s=>{this.plugin.settings.excludeFolders=s.split(",").map(i=>i.trim()).filter(i=>i.length>0),await this.plugin.saveSettings()}))}renderAutoAnalysisSection(e){if(e.createEl("h2",{text:"Auto Analysis"}),new b.Setting(e).setName("Enable Auto Analysis").setDesc("Automatically run gap analysis periodically").addToggle(t=>t.setValue(this.plugin.settings.autoAnalyze).onChange(async s=>{this.plugin.settings.autoAnalyze=s,await this.plugin.saveSettings()})),new b.Setting(e).setName("Analysis Interval (days)").setDesc("Interval for auto analysis").addSlider(t=>t.setLimits(1,30,1).setValue(this.plugin.settings.analyzeIntervalDays).setDynamicTooltip().onChange(async s=>{this.plugin.settings.analyzeIntervalDays=s,await this.plugin.saveSettings()})),this.plugin.settings.lastAnalyzedAt){let t=new Date(this.plugin.settings.lastAnalyzedAt);e.createEl("p",{text:`Last analysis: ${t.toLocaleDateString()} ${t.toLocaleTimeString()}`,cls:"setting-item-description"})}}renderAdvancedSection(e){e.createEl("h2",{text:"Advanced Settings"}),new b.Setting(e).setName("Use K-Means++ Initialization").setDesc("Use K-Means++ for better cluster initialization (recommended)").addToggle(t=>t.setValue(this.plugin.settings.useKMeansPlusPlus).onChange(async s=>{this.plugin.settings.useKMeansPlusPlus=s,await this.plugin.saveSettings()})),new b.Setting(e).setName("Reset to Defaults").setDesc("Reset all settings to defaults (API keys are preserved)").addButton(t=>t.setButtonText("Reset").setWarning().onClick(async()=>{let s={...this.plugin.settings.ai.apiKeys};this.plugin.settings={...M,ai:{...M.ai,apiKeys:s}},await this.plugin.saveSettings(),this.display()}))}};var C=require("obsidian");var de={includeTimestamp:!0,includeSummary:!0,maxGapsToShow:20,maxSparseRegions:10,maxUndefinedConcepts:15,showRelatedNotes:!0,showSuggestedTopics:!0},I=class{formatReport(n,e={}){let t={...de,...e},s=[];return s.push(`# Knowledge Gap Analysis Report
`),t.includeTimestamp&&s.push(`*Generated: ${n.analyzedAt.toLocaleString()}*
`),t.includeSummary&&s.push(this.formatSummary(n)),n.gaps.length>0&&s.push(this.formatGaps(n.gaps,t)),n.sparseRegions.length>0&&s.push(this.formatSparseRegions(n.sparseRegions,t)),n.undefinedConcepts.length>0&&s.push(this.formatUndefinedConcepts(n.undefinedConcepts,t)),s.push(this.formatFooter()),s.join(`
`)}formatSummary(n){let{gaps:e,sparseRegions:t,undefinedConcepts:s}=n,i={significant:e.filter(o=>o.severity==="significant").length,moderate:e.filter(o=>o.severity==="moderate").length,minor:e.filter(o=>o.severity==="minor").length},r={sparse_region:e.filter(o=>o.type==="sparse_region").length,undefined_concept:e.filter(o=>o.type==="undefined_concept").length,weak_connection:e.filter(o=>o.type==="weak_connection").length};return`## Summary

| Metric | Count |
|--------|-------|
| Total Gaps Detected | ${e.length} |
| Sparse Regions | ${t.length} |
| Undefined Concepts | ${s.length} |

### By Severity
- \u{1F534} **Significant**: ${i.significant}
- \u{1F7E1} **Moderate**: ${i.moderate}
- \u{1F7E2} **Minor**: ${i.minor}

### By Type
- \u{1F5FA}\uFE0F Sparse Regions: ${r.sparse_region}
- \u2753 Undefined Concepts: ${r.undefined_concept}
- \u{1F517} Weak Connections: ${r.weak_connection}
`}formatGaps(n,e){let t=n.slice(0,e.maxGapsToShow),s=[`## Top Knowledge Gaps
`];for(let i of t)s.push(this.formatSingleGap(i,e));return n.length>(e.maxGapsToShow||20)&&s.push(`
*...and ${n.length-(e.maxGapsToShow||20)} more gaps*
`),s.join(`
`)}formatSingleGap(n,e){let t=this.getSeverityIcon(n.severity),s=this.getTypeIcon(n.type),i=[`### ${t} ${n.title}`,"",`**Type**: ${s} ${this.formatGapType(n.type)}`,`**Severity**: ${this.formatSeverity(n.severity)}`,"",n.description,""];if(e.showSuggestedTopics&&n.suggestedTopics.length>0){i.push("**Suggested Topics to Explore**:");for(let r of n.suggestedTopics.slice(0,5))i.push(`- ${r}`);i.push("")}if(e.showRelatedNotes&&n.relatedNotes.length>0){i.push("**Related Notes**:");for(let r of n.relatedNotes.slice(0,5))i.push(`- [[${this.extractNoteName(r)}]]`);i.push("")}return i.join(`
`)}formatSparseRegions(n,e){let t=n.slice(0,e.maxSparseRegions),s=[`## Sparse Regions
`];s.push(`These are areas in your knowledge graph with low note density - potential areas for expansion.
`);for(let i=0;i<t.length;i++){let r=t[i];s.push(this.formatSingleSparseRegion(r,i+1))}return n.length>(e.maxSparseRegions||10)&&s.push(`
*...and ${n.length-(e.maxSparseRegions||10)} more sparse regions*
`),s.join(`
`)}formatSingleSparseRegion(n,e){let t=(n.density*100).toFixed(1),s=this.getDensityBar(n.density),i=[`### ${e}. ${n.inferredTopic||`Region ${n.id}`}`,"",`**Density**: ${s} ${t}%`,`**Notes in Area**: ${n.noteCount}`,""];if(n.nearestNotes.length>0){i.push("**Nearest Notes**:");for(let r of n.nearestNotes.slice(0,3))i.push(`- [[${this.extractNoteName(r.notePath)}]] (distance: ${r.distance.toFixed(3)})`);i.push("")}if(n.boundaryNotes.length>0){i.push("**Boundary Notes** (potential bridges):");for(let r of n.boundaryNotes.slice(0,3))i.push(`- [[${this.extractNoteName(r)}]]`);i.push("")}return i.join(`
`)}formatUndefinedConcepts(n,e){let t=n.slice(0,e.maxUndefinedConcepts),s=[`## Undefined Concepts
`];s.push(`These concepts are referenced in your notes but don't have dedicated notes yet.
`),s.push("| Concept | Mentions | Sources |"),s.push("|---------|----------|---------|");for(let i of t){let r=i.mentionedIn.slice(0,3).map(a=>this.extractNoteName(a)).join(", "),o=i.mentionedIn.length>3?"...":"";s.push(`| [[${i.name}]] | ${i.mentionCount} | ${r}${o} |`)}n.length>(e.maxUndefinedConcepts||15)&&s.push(`
*...and ${n.length-(e.maxUndefinedConcepts||15)} more undefined concepts*
`),s.push(`
### Quick Actions
`),s.push(`Top 5 concepts to define (by mention count):
`);for(let i of n.slice(0,5))s.push(`1. **[[${i.name}]]** - mentioned ${i.mentionCount} times`),i.relatedConcepts.length>0&&s.push(`   - Related to: ${i.relatedConcepts.slice(0,3).join(", ")}`);return s.push(""),s.join(`
`)}formatFooter(){return`---

## Next Steps

1. **Review significant gaps** - Start with \u{1F534} marked items
2. **Create notes for top undefined concepts** - Build foundational knowledge
3. **Explore sparse regions** - Consider what topics might bridge existing notes
4. **Re-run analysis** - After creating new notes to track progress

---
*Generated by Knowledge Gap Detector*
`}getSeverityIcon(n){switch(n){case"significant":return"\u{1F534}";case"moderate":return"\u{1F7E1}";case"minor":return"\u{1F7E2}";default:return"\u26AA"}}getTypeIcon(n){switch(n){case"sparse_region":return"\u{1F5FA}\uFE0F";case"undefined_concept":return"\u2753";case"weak_connection":return"\u{1F517}";default:return"\u{1F4DD}"}}formatGapType(n){switch(n){case"sparse_region":return"Sparse Region";case"undefined_concept":return"Undefined Concept";case"weak_connection":return"Weak Connection";default:return n}}formatSeverity(n){return n.charAt(0).toUpperCase()+n.slice(1)}getDensityBar(n){let e=Math.round(n*10),t=10-e;return"\u2588".repeat(e)+"\u2591".repeat(t)}extractNoteName(n){let e=n.split(/[/\\]/);return e[e.length-1].replace(/\.md$/,"")}formatQuickSummary(n){let{gaps:e,sparseRegions:t,undefinedConcepts:s}=n,i=e.filter(r=>r.severity==="significant").length;return`**${e.length}** gaps detected (${i} significant)
**${t.length}** sparse regions found
**${s.length}** undefined concepts`}formatGapListItem(n){let e=this.getSeverityIcon(n.severity),t=this.getTypeIcon(n.type);return`${e} ${t} **${n.title}**
   ${n.description.slice(0,100)}${n.description.length>100?"...":""}`}};var k=class extends C.Modal{constructor(e,t){super(e);this.activeTab="overview";this.report=t,this.presenter=new I}onOpen(){let{contentEl:e,modalEl:t}=this;t.addClass("knowledge-gap-modal"),this.renderHeader(e),this.renderTabs(e);let s=e.createDiv({cls:"gap-report-content"});this.renderTabContent(s)}onClose(){this.contentEl.empty()}renderHeader(e){let t=e.createDiv({cls:"gap-report-header"}),s=t.createDiv({cls:"gap-report-title-container"}),i=s.createSpan({cls:"gap-report-icon"});(0,C.setIcon)(i,"search"),s.createEl("h2",{text:"Knowledge Gap Analysis"});let r=t.createDiv({cls:"gap-report-stats"}),o=this.report.gaps.filter(l=>l.severity==="significant").length;this.createStatBadge(r,"Total Gaps",this.report.gaps.length.toString(),"search"),this.createStatBadge(r,"Significant",o.toString(),"alert-circle"),this.createStatBadge(r,"Sparse Regions",this.report.sparseRegions.length.toString(),"map"),this.createStatBadge(r,"Undefined",this.report.undefinedConcepts.length.toString(),"help-circle");let c=t.createDiv({cls:"gap-report-actions"}).createEl("button",{text:"Export as Markdown",cls:"mod-cta"});c.onclick=()=>this.exportReport()}createStatBadge(e,t,s,i){let r=e.createDiv({cls:"stat-badge"}),o=r.createSpan({cls:"stat-icon"});(0,C.setIcon)(o,i),r.createSpan({cls:"stat-value",text:s}),r.createSpan({cls:"stat-label",text:t})}renderTabs(e){let t=e.createDiv({cls:"gap-report-tabs"}),s=[{id:"overview",label:"Overview",icon:"layout-dashboard"},{id:"gaps",label:"Top Gaps",icon:"alert-triangle"},{id:"sparse",label:"Sparse Regions",icon:"map"},{id:"undefined",label:"Undefined Concepts",icon:"help-circle"}];for(let i of s){let r=t.createDiv({cls:`gap-report-tab ${this.activeTab===i.id?"active":""}`}),o=r.createSpan({cls:"tab-icon"});(0,C.setIcon)(o,i.icon),r.createSpan({text:i.label}),r.onclick=()=>{this.activeTab=i.id,this.refreshContent()}}}refreshContent(){let{contentEl:e}=this;e.querySelectorAll(".gap-report-tab").forEach((i,r)=>{let o=["overview","gaps","sparse","undefined"];i.removeClass("active"),o[r]===this.activeTab&&i.addClass("active")});let s=e.querySelector(".gap-report-content");s&&(s.empty(),this.renderTabContent(s))}renderTabContent(e){switch(this.activeTab){case"overview":this.renderOverview(e);break;case"gaps":this.renderGapsList(e);break;case"sparse":this.renderSparseRegions(e);break;case"undefined":this.renderUndefinedConcepts(e);break}}renderOverview(e){let t=e.createDiv({cls:"gap-overview"}),s=t.createDiv({cls:"overview-section"});s.createEl("h3",{text:"Summary"});let i=s.createDiv({cls:"summary-grid"}),r=i.createDiv({cls:"summary-card"});r.createEl("h4",{text:"By Severity"});let o=["significant","moderate","minor"],a={significant:"\u{1F534}",moderate:"\u{1F7E1}",minor:"\u{1F7E2}"};for(let h of o){let f=this.report.gaps.filter(v=>v.severity===h).length;r.createEl("p",{text:`${a[h]} ${h.charAt(0).toUpperCase()+h.slice(1)}: ${f}`})}let c=i.createDiv({cls:"summary-card"});c.createEl("h4",{text:"By Type"});let l=["sparse_region","undefined_concept","weak_connection"],p={sparse_region:"\u{1F5FA}\uFE0F Sparse Regions",undefined_concept:"\u2753 Undefined Concepts",weak_connection:"\u{1F517} Weak Connections"};for(let h of l){let f=this.report.gaps.filter(v=>v.type===h).length;c.createEl("p",{text:`${p[h]}: ${f}`})}let g=t.createDiv({cls:"overview-section"});g.createEl("h3",{text:"Top Recommendations"});let u=this.report.gaps.slice(0,5);if(u.length===0)g.createEl("p",{text:"No significant gaps detected. Your knowledge base looks healthy!",cls:"no-gaps-message"});else{let h=g.createEl("ol",{cls:"recommendations-list"});for(let f of u){let v=h.createEl("li");v.createEl("strong",{text:f.title}),v.createEl("span",{text:` - ${f.description.slice(0,100)}...`})}}t.createDiv({cls:"overview-section analysis-info"}).createEl("p",{text:`Analysis completed: ${this.report.analyzedAt.toLocaleString()}`,cls:"analysis-timestamp"})}renderGapsList(e){let t=e.createDiv({cls:"gaps-list"});if(this.report.gaps.length===0){t.createEl("p",{text:"No knowledge gaps detected.",cls:"empty-message"});return}for(let s of this.report.gaps)this.renderGapCard(t,s)}renderGapCard(e,t){var a;let s=e.createDiv({cls:`gap-card severity-${t.severity}`}),i=s.createDiv({cls:"gap-card-header"}),r=this.getSeverityIcon(t.severity),o=this.getTypeIcon(t.type);if(i.createEl("span",{text:`${r} ${o}`,cls:"gap-icons"}),i.createEl("h4",{text:t.title}),s.createEl("p",{text:t.description,cls:"gap-description"}),t.suggestedTopics.length>0){let c=s.createDiv({cls:"gap-topics"});c.createEl("strong",{text:"Explore: "}),c.createEl("span",{text:t.suggestedTopics.slice(0,3).join(", ")})}if(t.relatedNotes.length>0){let c=s.createDiv({cls:"gap-related"});c.createEl("strong",{text:"Related: "});for(let l of t.relatedNotes.slice(0,3)){let p=((a=l.split("/").pop())==null?void 0:a.replace(".md",""))||l,g=c.createEl("a",{text:p,cls:"internal-link"});g.onclick=u=>{u.preventDefault(),this.app.workspace.openLinkText(l,"")},c.createEl("span",{text:" "})}}}renderSparseRegions(e){let t=e.createDiv({cls:"sparse-list"});if(this.report.sparseRegions.length===0){t.createEl("p",{text:"No sparse regions detected. Your knowledge coverage is good!",cls:"empty-message"});return}for(let s=0;s<this.report.sparseRegions.length;s++)this.renderSparseRegionCard(t,this.report.sparseRegions[s],s+1)}renderSparseRegionCard(e,t,s){var l;let i=e.createDiv({cls:"sparse-card"}),r=i.createDiv({cls:"sparse-card-header"});r.createEl("span",{text:`#${s}`,cls:"sparse-index"}),r.createEl("h4",{text:t.inferredTopic||`Region ${t.id}`});let o=i.createDiv({cls:"density-container"});o.createEl("span",{text:"Density: ",cls:"density-label"});let c=o.createDiv({cls:"density-bar"}).createDiv({cls:"density-fill"});if(c.style.width=`${t.density*100}%`,o.createEl("span",{text:`${(t.density*100).toFixed(1)}%`,cls:"density-value"}),t.nearestNotes.length>0){let p=i.createDiv({cls:"nearby-notes"});p.createEl("strong",{text:"Nearby Notes: "});for(let g of t.nearestNotes.slice(0,3)){let u=((l=g.notePath.split("/").pop())==null?void 0:l.replace(".md",""))||g.notePath,m=p.createEl("a",{text:u,cls:"internal-link"});m.onclick=h=>{h.preventDefault(),this.app.workspace.openLinkText(g.notePath,"")},p.createEl("span",{text:" "})}}}renderUndefinedConcepts(e){let t=e.createDiv({cls:"undefined-list"});if(this.report.undefinedConcepts.length===0){t.createEl("p",{text:"No undefined concepts found. All referenced concepts have dedicated notes!",cls:"empty-message"});return}let s=t.createEl("table",{cls:"undefined-table"}),r=s.createEl("thead").createEl("tr");r.createEl("th",{text:"Concept"}),r.createEl("th",{text:"Mentions"}),r.createEl("th",{text:"Sources"}),r.createEl("th",{text:"Action"});let o=s.createEl("tbody");for(let a of this.report.undefinedConcepts)this.renderUndefinedConceptRow(o,a)}renderUndefinedConceptRow(e,t){var l;let s=e.createEl("tr");s.createEl("td").createEl("strong",{text:t.name}),s.createEl("td",{text:t.mentionCount.toString()});let r=s.createEl("td"),o=t.mentionedIn.slice(0,2);for(let p of o){let g=((l=p.split("/").pop())==null?void 0:l.replace(".md",""))||p,u=r.createEl("a",{text:g,cls:"internal-link"});u.onclick=m=>{m.preventDefault(),this.app.workspace.openLinkText(p,"")},r.createEl("span",{text:" "})}t.mentionedIn.length>2&&r.createEl("span",{text:`+${t.mentionedIn.length-2} more`});let c=s.createEl("td").createEl("button",{text:"Create Note",cls:"mod-cta"});c.onclick=()=>this.createNoteForConcept(t)}async createNoteForConcept(e){let t=`# ${e.name}

<!-- TODO: Define this concept -->

## Related Concepts

${e.relatedConcepts.slice(0,5).map(i=>`- [[${i}]]`).join(`
`)}

## Mentioned In

${e.mentionedIn.slice(0,10).map(i=>{var r;return`- [[${((r=i.split("/").pop())==null?void 0:r.replace(".md",""))||i}]]`}).join(`
`)}
`,s=(0,C.normalizePath)(`${e.name}.md`);try{await this.app.vault.create(s,t),new C.Notice(`Created note: ${e.name}`),await this.app.workspace.openLinkText(s,"")}catch(i){let r=i instanceof Error?i.message:String(i);r.includes("already exists")||r.includes("File exists")?(new C.Notice(`Note already exists: ${e.name}`),await this.app.workspace.openLinkText(s,"")):new C.Notice(`Failed to create note: ${r}`)}}async exportReport(){let e=this.presenter.formatReport(this.report),t=(0,C.normalizePath)(`Knowledge-Gap-Report-${new Date().toISOString().split("T")[0]}.md`);try{await this.app.vault.create(t,e),new C.Notice(`Report exported: ${t}`),await this.app.workspace.openLinkText(t,"")}catch(s){let i=s instanceof Error?s.message:String(s);i.includes("already exists")||i.includes("File exists")?(new C.Notice(`Report file already exists, opening: ${t}`),await this.app.workspace.openLinkText(t,"")):new C.Notice(`Failed to export report: ${i}`)}}getSeverityIcon(e){switch(e){case"significant":return"\u{1F534}";case"moderate":return"\u{1F7E1}";case"minor":return"\u{1F7E2}";default:return"\u26AA"}}getTypeIcon(e){switch(e){case"sparse_region":return"\u{1F5FA}\uFE0F";case"undefined_concept":return"\u2753";case"weak_connection":return"\u{1F517}";default:return"\u{1F4DD}"}}};function B(d){return{id:d.id,type:d.type,title:d.title,description:d.description,severity:d.severity,suggestedTopics:d.suggestedTopics||[],relatedNotes:d.relatedNotes||[],detectedAt:new Date}}function Q(d){return{id:d.id,centroid:d.centroid,density:d.density,nearestNotes:d.nearestNotes,boundaryNotes:d.boundaryNotes||[],noteCount:d.noteCount,inferredTopic:d.inferredTopic}}var R=class{constructor(n,e){this.embeddingReader=n;this.clusteringService=e}async execute(n={}){let{clusterCount:e,sparsityThreshold:t=.3,maxRegions:s=10,excludeFolders:i=[]}=n,r=await this.embeddingReader.readAllEmbeddings();if(r.size===0)return[];let o=this.filterExcludedFolders(r,i);if(o.size<3)return[];let a=new Map;for(let[u,m]of o)a.set(u,m.vector);let l={k:e||this.calculateOptimalK(a.size),maxIterations:100,tolerance:1e-4,useKMeansPlusPlus:!0},p=this.clusteringService.kMeans(a,l),g=[];for(let u of p.clusters){let m=this.clusteringService.calculateDensity(u,a);if(m<t){let h=this.findNearestNotes(u,o),f=this.findBoundaryNotes(u,o),v=Q({id:u.id,centroid:u.centroid,density:m,nearestNotes:h,boundaryNotes:f,noteCount:u.members.length});g.push(v)}}return g.sort((u,m)=>u.density-m.density).slice(0,s)}filterExcludedFolders(n,e){if(e.length===0)return n;let t=new Map;for(let[s,i]of n)e.some(o=>i.notePath.startsWith(o))||t.set(s,i);return t}calculateOptimalK(n){let e=Math.round(Math.sqrt(n/2));return Math.max(3,Math.min(20,e))}findNearestNotes(n,e){let t=[];for(let s of n.members){let i=e.get(s);if(i){let r=this.clusteringService.euclideanDistance(i.vector,n.centroid);t.push({notePath:i.notePath,distance:r})}}return t.sort((s,i)=>s.distance-i.distance)}findBoundaryNotes(n,e){let t=this.findNearestNotes(n,e),s=Math.min(3,Math.ceil(t.length*.2));return t.slice(-s).map(i=>i.notePath)}};function Y(d){return{name:d.name,mentionCount:d.mentionCount,mentionedIn:d.mentionedIn,relatedConcepts:d.relatedConcepts||[],suggestedContent:d.suggestedContent}}var T=class{constructor(n){this.linkGraphReader=n}async execute(n={}){let{minMentions:e=2,maxConcepts:t=50,analyzeCoOccurrence:s=!0,excludeFolders:i=[]}=n,r=await this.linkGraphReader.getUndefinedLinks(),o=this.filterLinks(r,e,i),a=[];for(let c of o){let l=[];s&&(l=this.linkGraphReader.getCoOccurringConcepts(c.linkText,2));let p=Y({name:c.linkText,mentionCount:c.count,mentionedIn:c.sources,relatedConcepts:l});a.push(p)}return a.sort((c,l)=>l.mentionCount-c.mentionCount).slice(0,t)}filterLinks(n,e,t){return n.filter(s=>!(s.count<e||t.length>0&&s.sources.filter(r=>!t.some(o=>r.startsWith(o))).length<e||this.isSystemLink(s.linkText)))}isSystemLink(n){return[/^Template/i,/^_/,/^\d{4}-\d{2}-\d{2}$/,/^MOC$/i,/^Index$/i,/^README$/i,/^TODO$/i,/^CHANGELOG$/i].some(t=>t.test(n))}};var G=class{constructor(n){this.llmService=n}async execute(n){return this.llmService.isAvailable()?this.llmService.generateExplorationSuggestions(n.description,n.relatedNotes,this.buildContext(n)):this.generateFallbackSuggestions(n)}async inferTopicForRegion(n,e){return this.llmService.isAvailable()?(await this.llmService.inferTopic(e)).topic:void 0}async suggestContentForConcept(n){if(this.llmService.isAvailable())return this.llmService.describeUndefinedConcept(n.name,n.mentionedIn)}buildContext(n){let e=[];return e.push(`Gap Type: ${n.type}`),e.push(`Severity: ${n.severity}`),n.relatedNotes.length>0&&e.push(`Related Notes: ${n.relatedNotes.slice(0,5).join(", ")}`),n.suggestedTopics.length>0&&e.push(`Initial Suggestions: ${n.suggestedTopics.join(", ")}`),e.join(`
`)}generateFallbackSuggestions(n){let e=[];switch(n.type){case"sparse_region":e.push({topic:n.title,questions:["What are the key concepts in this area?","How does this relate to your existing knowledge?","What resources could help you learn more?"],subtopics:n.suggestedTopics.slice(0,3),rationale:"This area has fewer notes compared to other parts of your knowledge base."});break;case"undefined_concept":e.push({topic:n.title,questions:[`What is ${n.title}?`,`Why is ${n.title} mentioned in your notes?`,`How does ${n.title} connect to your existing knowledge?`],subtopics:[],rationale:"This concept is frequently referenced but not yet documented."});break;case"weak_connection":e.push({topic:n.title,questions:["What bridges these isolated concepts?","Are there hidden relationships to explore?"],subtopics:n.suggestedTopics,rationale:"This area could benefit from better connections to other knowledge."});break}return e}};function N(d){return(d.split("/").pop()||d).replace(/\.md$/,"")}var D=class{constructor(n,e,t,s){this.embeddingReader=n;this.llmService=s;this.cancelled=!1;this.detectSparseRegions=new R(n,t),this.findUndefinedConcepts=new T(e),this.suggestExploration=new G(s)}onProgress(n){this.progressCallback=n}cancel(){this.cancelled=!0}async execute(n={}){this.cancelled=!1;let{clusterCount:e,minMentions:t=2,sparsityThreshold:s=.3,excludeFolders:i=[],useLLM:r=!0,maxGaps:o=50}=n;if(this.reportProgress("loading",0,"Loading embeddings..."),!await this.embeddingReader.isAvailable())throw new Error("Vault Embeddings data not found. Please ensure Vault Embeddings plugin is installed and has indexed your vault.");let c=await this.embeddingReader.getEmbeddingCount();if(this.reportProgress("loading",20,`Found ${c} embedded notes`),this.cancelled)return this.createEmptyReport(n);this.reportProgress("clustering",25,"Analyzing embedding clusters...");let l=await this.detectSparseRegions.execute({clusterCount:e,sparsityThreshold:s,excludeFolders:i});if(this.reportProgress("clustering",50,`Found ${l.length} sparse regions`),this.cancelled)return this.createEmptyReport(n);this.reportProgress("analyzing_links",55,"Analyzing link graph...");let p=await this.findUndefinedConcepts.execute({minMentions:t,excludeFolders:i});if(this.reportProgress("analyzing_links",70,`Found ${p.length} undefined concepts`),this.cancelled)return this.createEmptyReport(n);let g=l,u=p;if(r&&this.llmService.isAvailable()&&(this.reportProgress("generating_suggestions",75,"Generating topic suggestions..."),g=await this.enrichSparseRegions(l),this.reportProgress("generating_suggestions",85,"Enriching concepts..."),u=await this.enrichUndefinedConcepts(p.slice(0,10))),this.cancelled)return this.createEmptyReport(n);this.reportProgress("generating_suggestions",90,"Creating gap report...");let m=this.createKnowledgeGaps(g,u),h=this.sortGapsByPriority(m).slice(0,o);return this.reportProgress("complete",100,"Analysis complete"),{analyzedAt:new Date,totalNotesAnalyzed:c,totalEmbeddings:c,sparseRegions:g,undefinedConcepts:u,gaps:h,options:n}}reportProgress(n,e,t){this.progressCallback&&this.progressCallback({phase:n,progress:e,message:t})}async enrichSparseRegions(n){let e=[];for(let t of n){if(this.cancelled)break;let s=t.nearestNotes.slice(0,5).map(r=>N(r.notePath)),i=await this.suggestExploration.inferTopicForRegion(t,s);e.push({...t,inferredTopic:i||`Cluster ${t.id}`})}return e}async enrichUndefinedConcepts(n){let e=[];for(let t of n){if(this.cancelled)break;let s=await this.suggestExploration.suggestContentForConcept(t);e.push({...t,suggestedContent:s})}return e}createKnowledgeGaps(n,e){let t=[];for(let s of n){let i=this.calculateSparseRegionSeverity(s);t.push(B({id:`sparse-${s.id}`,type:"sparse_region",title:s.inferredTopic||`Low Coverage Area ${s.id}`,description:`This area of your knowledge base has low note density (${(s.density*100).toFixed(1)}%). Consider exploring topics related to: ${s.nearestNotes.slice(0,3).map(r=>N(r.notePath)).join(", ")}.`,severity:i,suggestedTopics:s.nearestNotes.slice(0,5).map(r=>N(r.notePath)),relatedNotes:s.nearestNotes.slice(0,10).map(r=>r.notePath)}))}for(let s of e){let i=this.calculateConceptSeverity(s);t.push(B({id:`undefined-${s.name.replace(/\s+/g,"-").toLowerCase()}`,type:"undefined_concept",title:s.name,description:`"${s.name}" is mentioned ${s.mentionCount} times but has no dedicated note.${s.suggestedContent?` Suggested focus: ${s.suggestedContent.slice(0,100)}...`:""}`,severity:i,suggestedTopics:s.relatedConcepts.slice(0,5),relatedNotes:s.mentionedIn.slice(0,10)}))}return t}calculateSparseRegionSeverity(n){return n.density<.1?"significant":n.density<.2?"moderate":"minor"}calculateConceptSeverity(n){return n.mentionCount>=10?"significant":n.mentionCount>=5?"moderate":"minor"}sortGapsByPriority(n){let e={significant:3,moderate:2,minor:1};return[...n].sort((t,s)=>{let i=e[s.severity]-e[t.severity];return i!==0?i:t.type==="undefined_concept"&&s.type!=="undefined_concept"?-1:s.type==="undefined_concept"&&t.type!=="undefined_concept"?1:0})}createEmptyReport(n){return{analyzedAt:new Date,totalNotesAnalyzed:0,totalEmbeddings:0,sparseRegions:[],undefinedConcepts:[],gaps:[],options:n}}};var L=require("obsidian"),V="09_Embedded",X="index.json",pe="embeddings",$=class{constructor(n){this.vault=n;this.cachedIndex=null;this.embeddingsCache=new Map}async isAvailable(){let n=(0,L.normalizePath)(`${V}/${X}`);return this.vault.getAbstractFileByPath(n)!==null}async readIndex(){if(this.cachedIndex)return this.cachedIndex;let n=(0,L.normalizePath)(`${V}/${X}`);try{if(!this.vault.getAbstractFileByPath(n)&&!await this.vault.adapter.exists(n))return null;let t=await this.vault.adapter.read(n);return this.cachedIndex=JSON.parse(t),this.cachedIndex}catch(e){return console.error("Failed to read embedding index:",e),null}}async readEmbedding(n){let e=this.embeddingsCache.get(n);if(e)return e;let t=(0,L.normalizePath)(`${V}/${pe}/${n}.json`);try{if(!await this.vault.adapter.exists(t))return null;let i=await this.vault.adapter.read(t),r=JSON.parse(i);return this.embeddingsCache.set(n,r),r}catch(s){return console.error(`Failed to read embedding for ${n}:`,s),null}}async readAllEmbeddings(){if(this.embeddingsCache.size>0)return this.embeddingsCache;let n=await this.readIndex();if(!n)return new Map;let e=new Map,t=Object.keys(n.notes),s=50;for(let i=0;i<t.length;i+=s){let r=t.slice(i,i+s),o=await Promise.all(r.map(a=>this.readEmbedding(a)));for(let a=0;a<r.length;a++){let c=o[a];c&&e.set(r[a],c)}}return this.embeddingsCache=e,e}async getEmbeddingCount(){let n=await this.readIndex();return n?n.totalNotes:0}clearCache(){this.cachedIndex=null,this.embeddingsCache.clear()}async getEmbeddingByPath(n){let e=await this.readIndex();if(!e)return null;for(let[t,s]of Object.entries(e.notes))if(s.path===n)return this.readEmbedding(t);return null}};var j=require("obsidian"),Z=/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/g,ue=new Set([".png",".jpg",".jpeg",".gif",".svg",".webp",".bmp",".ico",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".mp3",".wav",".ogg",".m4a",".flac",".mp4",".mov",".avi",".mkv",".webm",".zip",".rar",".7z",".tar",".gz",".css",".js",".json",".xml",".html",".htm"]),U=class{constructor(n){this.vault=n;this.linkGraph=null;this.excludeFolders=[]}setExcludeFolders(n){this.excludeFolders=n.map(e=>(0,j.normalizePath)(e)),this.linkGraph=null}async buildGraph(){if(this.linkGraph)return this.linkGraph;let n=new Map,e=new Map,t=new Map,s=this.vault.getMarkdownFiles(),i=new Set;for(let r of s){let o=r.path.replace(/\.md$/,"");i.add(o),i.add(r.basename)}for(let r of s){if(this.shouldExclude(r.path))continue;let o=await this.vault.cachedRead(r),a=this.extractLinks(o),c=this.extractTags(o);n.set(r.path,{path:r.path,outgoingLinks:a,tags:c});for(let l of a){let p=this.normalizeLinkTarget(l);if(i.has(p)||i.has(l)){let u=this.findNotePath(p,s)||p,m=e.get(u)||new Set;m.add(r.path),e.set(u,m)}else{let u=t.get(l);u?(u.count++,u.sources.includes(r.path)||u.sources.push(r.path)):t.set(l,{linkText:l,sources:[r.path],count:1})}}}return this.linkGraph={notes:n,incomingLinks:e,undefinedLinks:t},this.linkGraph}async getUndefinedLinks(){let n=await this.buildGraph();return Array.from(n.undefinedLinks.values())}getLinkFrequency(n){if(!this.linkGraph)return 0;let e=this.linkGraph.undefinedLinks.get(n);if(e)return e.count;let t=this.linkGraph.incomingLinks.get(n);return t?t.size:0}getNotesMentioning(n){if(!this.linkGraph)return[];let e=this.linkGraph.undefinedLinks.get(n);if(e)return e.sources;let t=this.linkGraph.incomingLinks.get(n);return t?Array.from(t):[]}getCoOccurringConcepts(n,e=2){if(!this.linkGraph)return[];let t=this.getNotesMentioning(n);if(t.length===0)return[];let s=new Map;for(let i of t){let r=this.linkGraph.notes.get(i);if(r)for(let o of r.outgoingLinks)o!==n&&s.set(o,(s.get(o)||0)+1)}return Array.from(s.entries()).filter(([i,r])=>r>=e).sort((i,r)=>r[1]-i[1]).map(([i])=>i)}clearCache(){this.linkGraph=null}shouldExclude(n){return this.excludeFolders.some(e=>n.startsWith((0,j.normalizePath)(e)))}extractLinks(n){let e=[],t;for(Z.lastIndex=0;(t=Z.exec(n))!==null;){let s=t[1].trim();if(s&&!e.includes(s)){if(this.isExcludedFileType(s)||this.shouldExclude(s))continue;e.push(s)}}return e}isExcludedFileType(n){let e=n.toLowerCase();for(let t of ue)if(e.endsWith(t))return!0;return!1}extractTags(n){let e=[],t=/(?:^|\s)#([a-zA-Z0-9_\-/]+)/g,s;for(;(s=t.exec(n))!==null;){let i=s[1];i&&!e.includes(i)&&e.push(i)}return e}normalizeLinkTarget(n){return n.split("/").pop()||n}findNotePath(n,e){for(let t of e)if(t.basename===n||t.path===n+".md")return t.path}};function ee(d,n){if(d.length!==n.length)throw new Error(`Vector length mismatch: ${d.length} vs ${n.length}`);let e=0,t=0,s=0;for(let r=0;r<d.length;r++)e+=d[r]*n[r],t+=d[r]*d[r],s+=n[r]*n[r];let i=Math.sqrt(t)*Math.sqrt(s);return i===0?0:e/i}function S(d,n){if(d.length!==n.length)throw new Error(`Vector length mismatch: ${d.length} vs ${n.length}`);let e=0;for(let t=0;t<d.length;t++){let s=d[t]-n[t];e+=s*s}return Math.sqrt(e)}function z(d){if(d.length===0)throw new Error("Cannot calculate centroid of empty vector set");let n=d[0].length,e=new Array(n).fill(0);for(let t of d)for(let s=0;s<n;s++)e[s]+=t[s];for(let t=0;t<n;t++)e[t]/=d.length;return e}var F=class{kMeans(n,e){let{k:t,maxIterations:s=100,tolerance:i=1e-4,useKMeansPlusPlus:r=!0}=e;if(n.size===0)return{clusters:[],assignments:new Map};if(n.size<t)return this.createSinglePointClusters(n);let o=Array.from(n.entries()),a=o.map(([f])=>f),c=o.map(([,f])=>f),l;r?l=this.kMeansPlusPlusInit(c,t):l=this.randomInit(c,t);let p=new Array(c.length).fill(0),g=0,u=!1;for(;g<s&&!u;){let f=c.map(v=>this.findNearestCentroid(v,l));if(u=this.assignmentsEqual(p,f),p=f,!u){let v=this.updateCentroids(c,p,t);this.maxCentroidMovement(l,v)<i&&(u=!0),l=v}g++}let m=[],h=new Map;for(let f=0;f<t;f++){let v=[],A=[];for(let w=0;w<p.length;w++)p[w]===f&&(v.push(a[w]),A.push(c[w]));if(v.length>0){let w=`cluster-${f}`,te=this.calculateVariance(A,l[f]);m.push({id:w,centroid:l[f],members:v,variance:te});for(let ne of v)h.set(ne,w)}}return{clusters:m,assignments:h,iterations:g}}dbscan(n,e){let{eps:t,minPts:s}=e,i=Array.from(n.entries()),r=i.map(([m])=>m),o=i.map(([,m])=>m),a=o.length,c=new Array(a).fill(-2),l=0;for(let m=0;m<a;m++){if(c[m]!==-2)continue;let h=this.regionQuery(o,m,t);h.length<s?c[m]=-1:(this.expandCluster(o,c,m,h,l,t,s),l++)}let p=new Map,g=new Map;for(let m=0;m<a;m++){let h=c[m];if(h>=0){let f=p.get(h)||[];f.push(r[m]),p.set(h,f),g.set(r[m],`cluster-${h}`)}}let u=[];for(let[m,h]of p){let f=h.map(w=>n.get(w)),v=z(f),A=this.calculateVariance(f,v);u.push({id:`cluster-${m}`,centroid:v,members:h,variance:A})}return{clusters:u,assignments:g}}calculateDensity(n,e){if(n.members.length===0)return 0;let t=0;for(let c of n.members){let l=e.get(c);l&&(t+=S(l,n.centroid))}let s=t/n.members.length,i=Array.from(e.values()),r=z(i),o=0;for(let c of i)o+=S(c,r);if(o/=i.length,o===0)return 1;let a=s/o;return Math.max(0,Math.min(1,1-a/2))}cosineSimilarity(n,e){return ee(n,e)}euclideanDistance(n,e){return S(n,e)}findOptimalK(n,e,t){let s=[];for(let o=e;o<=t;o++){let c=this.kMeans(n,{k:o,maxIterations:50}).clusters.reduce((l,p)=>l+p.variance*p.members.length,0);s.push(c)}let i=0,r=e;for(let o=1;o<s.length-1;o++){let a=Math.abs(s[o-1]-2*s[o]+s[o+1]);a>i&&(i=a,r=e+o)}return r}kMeansPlusPlusInit(n,e){let t=[],s=n.length,i=Math.floor(Math.random()*s);t.push([...n[i]]);for(let r=1;r<e;r++){let o=n.map(l=>{let p=Math.min(...t.map(g=>S(l,g)));return p*p}),a=o.reduce((l,p)=>l+p,0),c=Math.random()*a;for(let l=0;l<s;l++)if(c-=o[l],c<=0){t.push([...n[l]]);break}}return t}randomInit(n,e){let t=[],s=new Set;for(;s.size<e;)s.add(Math.floor(Math.random()*n.length));for(let i of s)t.push([...n[i]]);return t}findNearestCentroid(n,e){let t=1/0,s=0;for(let i=0;i<e.length;i++){let r=S(n,e[i]);r<t&&(t=r,s=i)}return s}updateCentroids(n,e,t){let s=n[0].length,i=[];for(let r=0;r<t;r++){let o=n.filter((a,c)=>e[c]===r);o.length>0?i.push(z(o)):i.push(new Array(s).fill(0))}return i}assignmentsEqual(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(n[t]!==e[t])return!1;return!0}maxCentroidMovement(n,e){let t=0;for(let s=0;s<n.length;s++){let i=S(n[s],e[s]);i>t&&(t=i)}return t}calculateVariance(n,e){if(n.length===0)return 0;let t=0;for(let s of n){let i=S(s,e);t+=i*i}return t/n.length}createSinglePointClusters(n){let e=[],t=new Map,s=0;for(let[i,r]of n){let o=`cluster-${s}`;e.push({id:o,centroid:r,members:[i],variance:0}),t.set(i,o),s++}return{clusters:e,assignments:t}}regionQuery(n,e,t){let s=[];for(let i=0;i<n.length;i++)S(n[e],n[i])<=t&&s.push(i);return s}expandCluster(n,e,t,s,i,r,o){e[t]=i;let a=[...s];for(;a.length>0;){let c=a.shift();if(e[c]===-1&&(e[c]=i),e[c]!==-2)continue;e[c]=i;let l=this.regionQuery(n,c,r);l.length>=o&&a.push(...l)}}};var E=require("obsidian");var O=class{constructor(n){this.config=n}updateConfig(n){this.config={...this.config,...n}}isAvailable(){return this.config.apiKey.length>0}async testApiKey(n,e){try{let t=x[n],s={provider:n,apiKey:e,model:t.defaultModel};return(await this.generateWithConfig([{role:"user",content:"Hello"}],s,10)).success}catch(t){return!1}}async generate(n,e){let t=[];return e&&t.push({role:"system",content:e}),t.push({role:"user",content:n}),this.generateWithConfig(t,this.config)}async inferTopic(n,e){let t=e?`

Note excerpts:
${e.slice(0,5).join(`
---
`)}`:"",s=`Based on these note titles from a knowledge base, infer the main topic or theme that connects them:

Note titles:
${n.slice(0,10).join(`
`)}${t}

Respond with a JSON object:
{
  "topic": "inferred topic name",
  "confidence": 0.0-1.0,
  "reasoning": "brief explanation"
}`,i=await this.generate(s,"You are a knowledge analyst. Respond only with valid JSON.");if(!i.success||!i.content)return{topic:"Unknown",confidence:0,reasoning:i.error||"Failed to infer topic"};try{let r=JSON.parse(i.content);return{topic:r.topic||"Unknown",confidence:r.confidence||.5,reasoning:r.reasoning||""}}catch(r){return{topic:i.content.slice(0,50),confidence:.3,reasoning:"Could not parse response"}}}async generateExplorationSuggestions(n,e,t){let s=t?`

Additional context: ${t}`:"",i=`A knowledge gap has been detected in a personal knowledge base:

Gap description: ${n}

Related existing notes:
${e.slice(0,5).map(o=>`- ${o}`).join(`
`)}${s}

Suggest 3-5 specific topics or questions to explore to fill this knowledge gap.

Respond with a JSON array:
[
  {
    "topic": "topic to explore",
    "questions": ["question 1", "question 2"],
    "subtopics": ["subtopic 1", "subtopic 2"],
    "rationale": "why this would help"
  }
]`,r=await this.generate(i,"You are a learning advisor. Respond only with valid JSON array.");if(!r.success||!r.content)return[];try{let o=JSON.parse(r.content);return Array.isArray(o)?o:[]}catch(o){return[]}}async describeUndefinedConcept(n,e){let t=`The concept "[[${n}]]" is referenced in a knowledge base but has no dedicated note.

It appears in these notes:
${e.slice(0,5).map(i=>`- ${i}`).join(`
`)}

Provide a brief description (2-3 sentences) of what this concept likely refers to and why it might be worth creating a dedicated note for it.`,s=await this.generate(t,"You are a knowledge curator. Be concise.");return s.success&&s.content?s.content:`A concept referenced but not yet defined: ${n}`}async generateWithConfig(n,e,t=1024){switch(e.provider){case"claude":return this.generateClaude(n,e,t);case"openai":return this.generateOpenAI(n,e,t);case"gemini":return this.generateGemini(n,e,t);case"grok":return this.generateGrok(n,e,t);default:return{success:!1,content:"",error:"Unknown provider"}}}async generateClaude(n,e,t){var o;let{claudeMessages:s,systemPrompt:i}=this.convertToClaude(n),r={model:e.model,messages:s,max_tokens:t};i&&(r.system=i);try{let c=(await(0,E.requestUrl)({url:`${x.claude.endpoint}/messages`,method:"POST",headers:{"x-api-key":e.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(r)})).json;return c.error?{success:!1,content:"",error:c.error.message}:{success:!0,content:((o=c.content)==null?void 0:o.filter(p=>p.type==="text").map(p=>p.text).join(""))||"",usage:c.usage?{promptTokens:c.usage.input_tokens,completionTokens:c.usage.output_tokens,totalTokens:c.usage.input_tokens+c.usage.output_tokens}:void 0}}catch(a){return this.handleError(a)}}async generateOpenAI(n,e,t){var s,i,r;try{let o=H(e.model),a={model:e.model,messages:n.map(g=>({role:g.role,content:g.content}))};o?a.max_completion_tokens=Math.max(t*4,4096):a.max_tokens=t;let l=(await(0,E.requestUrl)({url:`${x.openai.endpoint}/chat/completions`,method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)})).json;return l.error?{success:!1,content:"",error:l.error.message}:{success:!0,content:((r=(i=(s=l.choices)==null?void 0:s[0])==null?void 0:i.message)==null?void 0:r.content)||"",usage:l.usage?{promptTokens:l.usage.prompt_tokens,completionTokens:l.usage.completion_tokens,totalTokens:l.usage.total_tokens}:void 0}}catch(o){return this.handleError(o)}}async generateGemini(n,e,t){var i,r,o,a,c;let s=this.convertToGemini(n);try{let l=`${x.gemini.endpoint}/models/${e.model}:generateContent?key=${e.apiKey}`,g=(await(0,E.requestUrl)({url:l,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:s,generationConfig:{maxOutputTokens:t}})})).json;return g.error?{success:!1,content:"",error:g.error.message}:{success:!0,content:((c=(a=(o=(r=(i=g.candidates)==null?void 0:i[0])==null?void 0:r.content)==null?void 0:o.parts)==null?void 0:a[0])==null?void 0:c.text)||"",usage:g.usageMetadata?{promptTokens:g.usageMetadata.promptTokenCount||0,completionTokens:g.usageMetadata.candidatesTokenCount||0,totalTokens:g.usageMetadata.totalTokenCount||0}:void 0}}catch(l){return this.handleError(l)}}async generateGrok(n,e,t){var s,i,r;try{let a=(await(0,E.requestUrl)({url:`${x.grok.endpoint}/chat/completions`,method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:e.model,messages:n.map(l=>({role:l.role,content:l.content})),max_tokens:t})})).json;return a.error?{success:!1,content:"",error:a.error.message}:{success:!0,content:((r=(i=(s=a.choices)==null?void 0:s[0])==null?void 0:i.message)==null?void 0:r.content)||"",usage:a.usage?{promptTokens:a.usage.prompt_tokens,completionTokens:a.usage.completion_tokens,totalTokens:a.usage.total_tokens}:void 0}}catch(o){return this.handleError(o)}}convertToClaude(n){let e=[],t=null;for(let s of n)s.role==="system"?t=s.content:e.push({role:s.role,content:s.content});return{claudeMessages:e,systemPrompt:t}}convertToGemini(n){let e=[];for(let s of n)s.role!=="system"&&e.push({role:s.role==="assistant"?"model":"user",parts:[{text:s.content}]});let t=n.find(s=>s.role==="system");return t&&e.length>0&&(e[0].parts[0].text=`${t.content}

${e[0].parts[0].text}`),e}handleError(n){let e=n instanceof Error?n.message:"Unknown error";return e.includes("429")||e.includes("rate")?{success:!1,content:"",error:"Rate limit exceeded. Please try again later."}:e.includes("401")||e.includes("403")?{success:!1,content:"",error:"Invalid API key or unauthorized access."}:e.includes("timeout")?{success:!1,content:"",error:"Request timed out. Please try again."}:{success:!1,content:"",error:e}}};var K=class extends y.Plugin{constructor(){super(...arguments);this.isAnalyzing=!1;this.lastReport=null}async onload(){console.log("Loading Knowledge Gap Detector plugin"),await this.loadSettings(),this.initializeServices(),this.addSettingTab(new P(this.app,this)),this.registerCommands(),this.addRibbonIcon("search","Analyze Knowledge Gaps",async()=>{await this.runAnalysis()}),this.checkAutoAnalysis()}onunload(){console.log("Unloading Knowledge Gap Detector plugin")}async loadSettings(){if(this.settings=Object.assign({},M,await this.loadData()),this.settings.lastReport)try{this.lastReport=J(this.settings.lastReport),console.log("Restored last gap report from",this.lastReport.analyzedAt)}catch(e){console.warn("Failed to restore last gap report:",e),this.lastReport=null}}async saveSettings(){var e;if(await this.saveData(this.settings),this.llmService){let t=this.settings.ai.provider;this.llmService.updateConfig({provider:t,apiKey:(e=this.settings.ai.apiKeys[t])!=null?e:"",model:this.settings.ai.models[t]})}}async testApiKey(e,t){return this.llmService.testApiKey(e,t)}initializeServices(){var t;this.embeddingReader=new $(this.app.vault),this.linkGraphReader=new U(this.app.vault),this.clusteringService=new F;let e=this.settings.ai.provider;this.llmService=new O({provider:e,apiKey:(t=this.settings.ai.apiKeys[e])!=null?t:"",model:this.settings.ai.models[e]}),this.linkGraphReader.setExcludeFolders(this.getNormalizedExcludeFolders()),this.detectSparseRegionsUseCase=new R(this.embeddingReader,this.clusteringService),this.findUndefinedConceptsUseCase=new T(this.linkGraphReader),this.analyzeGapsUseCase=new D(this.embeddingReader,this.linkGraphReader,this.clusteringService,this.llmService)}registerCommands(){this.addCommand({id:"analyze-knowledge-gaps",name:"Analyze Knowledge Gaps",callback:()=>this.runAnalysis()}),this.addCommand({id:"show-gap-report",name:"Show Last Gap Report",callback:()=>this.showLastReport()}),this.addCommand({id:"find-undefined-concepts",name:"Find Undefined Concepts",callback:()=>this.findUndefinedConcepts()}),this.addCommand({id:"detect-sparse-regions",name:"Detect Sparse Regions",callback:()=>this.detectSparseRegions()}),this.addCommand({id:"clear-analysis-cache",name:"Clear Analysis Cache",callback:()=>this.clearCache()})}async runAnalysis(){if(this.isAnalyzing){new y.Notice("Analysis already in progress...");return}if(!await this.embeddingReader.isAvailable()){new y.Notice("Vault Embeddings not found. Please install and run the Vault Embeddings plugin first.",1e4);return}this.isAnalyzing=!0;let t=new y.Notice("Analyzing knowledge gaps...",0);try{this.linkGraphReader.setExcludeFolders(this.getNormalizedExcludeFolders());let s=await this.analyzeGapsUseCase.execute({clusterCount:this.settings.clusterCount,sparsityThreshold:this.settings.sparseDensityThreshold,minMentions:this.settings.minMentionsForUndefined,useLLM:this.settings.ai.enabled&&this.llmService.isAvailable(),maxGaps:this.settings.maxGapsInReport,excludeFolders:this.getNormalizedExcludeFolders()});this.lastReport=s,this.settings.lastAnalyzedAt=Date.now(),this.settings.lastReport=W(s),await this.saveSettings(),t.hide(),new k(this.app,s).open();let i=s.gaps.filter(r=>r.severity==="significant").length;new y.Notice(`Analysis complete: ${s.gaps.length} gaps found (${i} significant)`)}catch(s){t.hide(),console.error("Knowledge gap analysis failed:",s),new y.Notice(`Analysis failed: ${s instanceof Error?s.message:"Unknown error"}`)}finally{this.isAnalyzing=!1}}showLastReport(){if(!this.lastReport){new y.Notice('No analysis report available. Run "Analyze Knowledge Gaps" first.');return}new k(this.app,this.lastReport).open()}async findUndefinedConcepts(){let e=new y.Notice("Finding undefined concepts...",0);try{let t=this.getNormalizedExcludeFolders();this.linkGraphReader.setExcludeFolders(t);let s=await this.findUndefinedConceptsUseCase.execute({minMentions:this.settings.minMentionsForUndefined,maxConcepts:this.settings.maxGapsInReport,excludeFolders:t});if(e.hide(),s.length===0)new y.Notice("No undefined concepts found!");else{let i={gaps:[],sparseRegions:[],undefinedConcepts:s,analyzedAt:new Date,totalNotesAnalyzed:0,totalEmbeddings:0,options:{}};new k(this.app,i).open(),new y.Notice(`Found ${s.length} undefined concepts`)}}catch(t){e.hide(),console.error("Find undefined concepts failed:",t),new y.Notice(`Failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async detectSparseRegions(){if(!await this.embeddingReader.isAvailable()){new y.Notice("Vault Embeddings not found. Please install and run the Vault Embeddings plugin first.",1e4);return}let t=new y.Notice("Detecting sparse regions...",0);try{let s=await this.detectSparseRegionsUseCase.execute({clusterCount:this.settings.clusterCount,sparsityThreshold:this.settings.sparseDensityThreshold,excludeFolders:this.getNormalizedExcludeFolders()});if(t.hide(),s.length===0)new y.Notice("No sparse regions detected!");else{let i={gaps:[],sparseRegions:s,undefinedConcepts:[],analyzedAt:new Date,totalNotesAnalyzed:0,totalEmbeddings:0,options:{}};new k(this.app,i).open(),new y.Notice(`Found ${s.length} sparse regions`)}}catch(s){t.hide(),console.error("Detect sparse regions failed:",s),new y.Notice(`Failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async clearCache(){this.embeddingReader.clearCache(),this.linkGraphReader.clearCache(),this.lastReport=null,this.settings.lastReport=null,await this.saveSettings(),new y.Notice("Analysis cache cleared")}checkAutoAnalysis(){if(!this.settings.autoAnalyze)return;let e=this.settings.lastAnalyzedAt;if(!e){setTimeout(()=>this.runAnalysis(),5e3);return}let t=this.settings.analyzeIntervalDays*24*60*60*1e3;Date.now()-e>=t&&setTimeout(()=>{new y.Notice("Running scheduled knowledge gap analysis...",3e3),this.runAnalysis()},5e3)}getNormalizedExcludeFolders(){return this.settings.excludeFolders.map(e=>(0,y.normalizePath)(e))}};
